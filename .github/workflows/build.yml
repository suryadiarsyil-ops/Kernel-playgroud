name: Kernel Playground Build

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout repo
      - name: Checkout
        uses: actions/checkout@v4

      # 2. Install dependencies
      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential bc bison flex libssl-dev libelf-dev dwarves ccache

      # 3. Setup ccache
      - name: Setup ccache
      # bukan working-directory 
        run: |
          echo 'export PATH="/usr/lib/ccache:$PATH"' >> $GITHUB_ENV

      # 4. Restore ccache
      - name: Restore ccache cache
        uses: actions/cache@v4
        with:
          path: /home/runner/.cache/ccache
          key: kernel-ccache-${{ github.sha }}
          restore-keys: |
            kernel-ccache-

      # 5. Show initial ccache stats
      - name: Show ccache stats
        run: ccache -s

      # 6. Clone kernel 6.6 LTS
      - name: Clone Linux kernel (6.6 LTS)
        run: |
          git clone --depth=1 --branch linux-6.6.y \
            https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git linux-src

      # 7. Apply custom kernel-config (optional)
      - name: Apply custom kernel config
        working-directory: linux-src
        run: |
          if [ -f ../kernel-config ]; then
            echo "[*] using kernel-config"
            cp ../kernel-config .config
            yes "" | make oldconfig
          else
            echo "[*] no custom kernel-config found"
            make defconfig
          fi

      # 8. Inline config tweaks
      - name: Inline config tweaks
        working-directory: linux-src
        run: |
          scripts/config --enable CONFIG_BPF
          scripts/config --set-val CONFIG_HZ 1000
          make olddefconfig

      # 9. AUTO FIX: Disable trusted certificate keys (no more certs error)
      - name: Disable kernel trusted key requirements
        working-directory: linux-src
        run: |
          scripts/config --disable CONFIG_SYSTEM_TRUSTED_KEYS
          scripts/config --disable CONFIG_SYSTEM_REVOCATION_KEYS
          scripts/config --set-str CONFIG_SYSTEM_TRUSTED_KEYS ""
          scripts/config --set-str CONFIG_SYSTEM_REVOCATION_KEYS ""
          make olddefconfig

      # 10. Apply custom patches (optional)
      - name: Apply custom patches
        working-directory: linux-src
        run: |
          if [ -d ../patches ]; then
            echo "[*] applying patches..."
            for p in ../patches/*.patch; do
              echo "patch: $p"
              git apply "$p"
            done
          else
            echo "[*] no patches found"
          fi

      # 11. Print final config
      - name: Kernel config summary
        working-directory: linux-src
        run: |
          make savedefconfig
          cat defconfig

      # 12. Record start time
      - name: Start time
        id: start
        run: echo "time_start=$(date +%s)" >> $GITHUB_ENV

      # 13. Build kernel
      - name: Build kernel
        working-directory: linux-src
        run: |
          make -j$(nproc)

      # 14. Measure build duration
      - name: End time + duration
        run: |
          end=$(date +%s)
          duration=$((end - time_start))
          echo "Build duration: $duration seconds"

      # 15. Upload logs
      - name: Upload build logs
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: linux-src/*.log
          if-no-files-found: ignore

      # 16. Upload built kernel image
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: kernel-image
          path: linux-src/arch/x86/boot/bzImage
