name: Kernel Playground Build

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      ARCH: arm64
      CCACHE_DIR: /home/runner/.cache/ccache
      CROSS_COMPILE: aarch64-linux-gnu-

    steps:
      # 1. Checkout repo
      - name: Checkout
        uses: actions/checkout@v4

      # 2. Install dependencies
      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            gcc-aarch64-linux-gnu \
            build-essential bc bison flex libssl-dev libelf-dev dwarves \
            ccache qemu-system-arm qemu-efi-aarch64

      # 3. Setup ccache
      - name: Setup ccache
        run: |
          echo 'export PATH="/usr/lib/ccache:$PATH"' >> $GITHUB_ENV

      # 4. Restore ccache
      - name: Restore ccache cache
        uses: actions/cache@v4
        with:
          path: /home/runner/.cache/ccache
          key: kernel-ccache-${{ github.sha }}
          restore-keys: |
            kernel-ccache-

      # 5. Initial ccache state
      - name: Show ccache stats
        run: ccache -s

      # 6. Clone Android Common Kernel GKI 5.10
      - name: Clone Android Common Kernel GKI 5.10
        run: |
          echo "[*] Cloning ACK GKI 5.10"
          git clone --depth=1 --branch android12-5.10 \
            https://android.googlesource.com/kernel/common linux-src

      # 7. Apply base defconfig (GKI)
      - name: Apply GKI defconfig
        working-directory: linux-src
        run: |
          make defconfig

      # 8. Disable broken certificate enforcement
      - name: Disable kernel certificate chain
        working-directory: linux-src
        run: |
          scripts/config --disable CONFIG_SYSTEM_TRUSTED_KEYS
          scripts/config --disable CONFIG_SYSTEM_REVOCATION_KEYS
          scripts/config --set-str CONFIG_SYSTEM_TRUSTED_KEYS ""
          scripts/config --set-str CONFIG_SYSTEM_REVOCATION_KEYS ""
          make olddefconfig

      # 9. Inline Tweaks (Opsional)
      - name: Inline tweaks
        working-directory: linux-src
        run: |
          scripts/config --enable CONFIG_BPF
          scripts/config --set-val CONFIG_HZ 1000
          make olddefconfig

      # 10. Start time
      - name: Start time
        id: start
        run: echo "time_start=$(date +%s)" >> $GITHUB_ENV

      # 11. Build Kernel Image + Modules
      - name: Build kernel & modules
        working-directory: linux-src
        run: |
          make -j$(nproc) Image.gz modules

      # 12. Clone / Validate AnyKernel3
      - name: Prepare AnyKernel3 (Auto-Healing)
        run: |
          echo "[*] Validating AnyKernel3 directory..."

          # If AnyKernel3 exists but NOT a directory â†’ remove it
          if [ -e AnyKernel3 ] && [ ! -d AnyKernel3 ]; then
            echo "[!] AnyKernel3 corrupted (file, not folder). Removing..."
            rm -f AnyKernel3
          fi

          # Clone if missing
          if [ ! -d AnyKernel3 ]; then
            echo "[*] Cloning fresh AnyKernel3..."
            git clone --depth=1 https://github.com/osm0sis/AnyKernel3 AnyKernel3
          else
            echo "[*] AnyKernel3 already exists. Cleaning leftover files..."
            rm -rf AnyKernel3/ramdisk AnyKernel3/zImage AnyKernel3/*.zip
          fi

          # Clean modules / dtb / dtbo folders
          mkdir -p AnyKernel3/modules/system/lib/modules
          mkdir -p AnyKernel3/dtb
          mkdir -p AnyKernel3/dtbo

          echo "[*] AnyKernel3 ready."

      # 13. Inject Kernel Image + Modules
      - name: Move Kernel, DTB and Modules (Safe Mode)
        run: |
          echo "[*] Injecting Image.gz..."
          cp linux-src/arch/arm64/boot/Image.gz AnyKernel3/Image.gz

          echo "[*] Injecting modules *.ko only..."
          mkdir -p AnyKernel3/modules/system/lib/modules
          find out-modules -type f -name "*.ko" -exec cp {} AnyKernel3/modules/system/lib/modules/ \;

          # remove symlink loops
          find AnyKernel3/modules -type l -delete

          echo "[*] Modules injected."

      # 14. Build Flashable ZIP
      - name: Create Final Flashable ZIP
        run: |
          echo "[*] Generating flashable ZIP..."

          # Append kernel version to anykernel.sh
          echo "kernel.string=MyCustomKernel-$(date +%Y%m%d)" >> AnyKernel3/anykernel.sh

          cd AnyKernel3
          zip -r9 ../MyCustomKernel-ARM64-$(date +%Y%m%d).zip ./*
          cd ..

          echo "[*] ZIP created successfully."

      # 15. Upload Final Artifact
      - name: Upload Final Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kernel-arm64-distribution
          path: |
            MyCustomKernel-ARM64-*.zip
            linux-src/arch/arm64/boot/Image.gz

      # 16. Move kernel + modules into AK3
      - name: Inject Kernel Files
        run: |
          cp linux-src/arch/arm64/boot/Image.gz AnyKernel3/
          cp -r linux-src/out-modules/lib AnyKernel3/modules/

      # 17. Create Flashable ZIP
      - name: Create Flashable ZIP
        run: |
          cd AnyKernel3
          echo "kernel.string=GKI-5.10-$(date +%Y%m%d)" >> anykernel.sh
          zip -r9 ../Kernel-GKI-5.10-$(date +%Y%m%d).zip ./*
          cd ..

      # 18. Upload artifacts
      - name: Upload Flashable ZIP + Kernel Image
        uses: actions/upload-artifact@v4
        with:
          name: kernel-output
          path: |
            Kernel-GKI-5.10-*.zip
            linux-src/arch/arm64/boot/Image.gz
            linux-src/out-modules
