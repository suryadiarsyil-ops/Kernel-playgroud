name: ðŸ“± Kernel Playground Build (ARM64)
on:
  workflow_dispatch:
  push:
    branches: [ main ]

env:
  # 1. Tentukan Arsitektur Target
  ARCH: arm64
  # 2. Tentukan Toolchain Prefix (Ganti jika pakai toolchain lain)
  CROSS_COMPILE: aarch64-linux-gnu-

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout repo
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 2. Install Dependencies + Toolchain Wajib (Cross-Compilation)
      - name: Install Build Dependencies and ARM64 Toolchain
        run: |
          sudo apt-get update
          # Dependensi standar kernel build
          sudo apt-get install -y \
            build-essential bc bison flex libssl-dev libelf-dev dwarves ccache openssl
          # Tambahan: Toolchain untuk cross-compile ke AArch64 (ARM64)
          sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu

      # 3. Setup ccache
      - name: Setup ccache
        run: |
          # Buat foldernya secara manual biar Actions gak komplain pas cleanup
          mkdir -p /home/runner/.cache/ccache
          echo "CCACHE_DIR=/home/runner/.cache/ccache" >> $GITHUB_ENV
          echo 'export PATH="/usr/lib/ccache:$PATH"' >> $GITHUB_ENV

      # 4. Restore ccache (Key diperbaiki biar lebih akurat)
      - name: Restore ccache Cache
        uses: actions/cache@v4
        with:
          path: /home/runner/.cache/ccache
          # Key cache berdasarkan ARCH dan config file (lebih spesifik)
          key: kernel-ccache-${{ env.ARCH }}-${{ hashFiles('linux-src/.config') }}-${{ github.sha }}
          restore-keys: |
            kernel-ccache-${{ env.ARCH }}-

      # 5. Show initial ccache stats
      - name: Show ccache stats
        run: ccache -s

      # 6. Clone kernel 6.6 LTS
      - name: Clone Linux kernel (6.6 LTS)
        run: |
          git clone --depth=1 --branch linux-6.6.y \
            https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git linux-src

      # 7. Apply custom kernel-config atau defconfig
      - name: Apply Custom Kernel Config
        working-directory: linux-src
        run: |
          if [ -f ../kernel-config ]; then
            echo "[*] Using custom kernel-config"
            cp ../kernel-config .config
            # oldconfig buat adopsi .config baru dengan defconfig sisa
            yes "" | make ${ARCH}_defconfig oldconfig 
          else
            echo "[*] No custom kernel-config found. Using default config for ${ARCH}."
            # Set default config untuk ARM64
            make defconfig
          fi

      # 8. Inline config tweaks (Disarankan cek lagi nilai HZ untuk baterai)
      - name: Inline Config Tweaks
        working-directory: linux-src
        run: |
          scripts/config --enable CONFIG_BPF
          # Ganti HZ ke 250 (Bagus buat trade-off Baterai/Responsif)
          scripts/config --set-val CONFIG_HZ 250 
          # Enable fitur wajib: OverlayFS (buat Termux/Linux modern)
          scripts/config --enable CONFIG_OVERLAY_FS
          # Konfig lain yang mungkin perlu diaktifkan di sini
          make olddefconfig

      # 9. SIGNING MODE â€” generate x509 key and inject (Opsional, hapus kalau gak perlu)
      - name: Generate Signing Keys
        working-directory: linux-src
        run: |
          mkdir -p certs
          openssl req -new -nodes -utf8 -sha256 \
            -subj "/CN=KernelAutoKey/" \
            -newkey rsa:2048 -keyout certs/signing_key.pem \
            -x509 -out certs/signing_key.x509.pem -days 3650
          scripts/config --set-str CONFIG_SYSTEM_TRUSTED_KEYS "certs/signing_key.x509.pem"
          scripts/config --disable CONFIG_SYSTEM_REVOCATION_KEYS
          make olddefconfig

      # 10. Apply custom patches (optional)
      - name: Apply Custom Patches
        working-directory: linux-src
        run: |
          if [ -d ../patches ]; then
            for p in ../patches/*.patch; do
              echo "patch: $p"
              # Gunakan git am kalau patch berformat commit atau git apply
              git apply "$p"
            done
          else
            echo "[*] No patches found"
          fi
          
      # 11. Print final config
      - name: Kernel Config Summary
        working-directory: linux-src
        run: |
          make savedefconfig
          cat defconfig

      # 12. Record start time
      - name: Record Start Time
        id: start
        run: echo "time_start=$(date +%s)" >> $GITHUB_ENV

      # 13. Build kernel Image + Modules
      - name: Build Kernel (Target Image.gz untuk ARM64)
        working-directory: linux-src
        run: |
          make -j$(nproc) Image.gz modules

      # 14. ðŸ› ï¸ Instalasi QEMU dan Dependensi Initramfs
      - name: Install QEMU and Initramfs Tools
        run: |
          # Instal QEMU System (untuk emulasi ARM64)
          sudo apt-get install -y qemu-system-aarch64
          # Instal BusyBox dan CPIO (untuk Ramdisk)
          sudo apt-get install -y busybox cpio
          
      # 15. ðŸ“ Buat Initramfs (Ramdisk Minimal)
      - name: Create Minimal BusyBox Initramfs
        run: |
          mkdir -p initramfs/bin initramfs/dev initramfs/etc initramfs/lib initramfs/proc initramfs/sys initramfs/tmp
          
          # Salin BusyBox. Kita pakai yang dari repo apt (binary statis yang aman)
          cp /bin/busybox initramfs/bin/
          
          # Buat init script
          echo "#!/bin/sh" > initramfs/init
          echo "mount -t proc none /proc" >> initramfs/init
          echo "mount -t sysfs none /sys" >> initramfs/init
          echo "echo '*** Custom Kernel Boot Success! ***'" >> initramfs/init
          echo "/bin/busybox sh" >> initramfs/init
          chmod +x initramfs/init
          
          # Buat device nodes kritis (WAJIB: console dan null)
          # Menggunakan sudo karena ini memerlukan elevated privileges di runner
          sudo mknod initramfs/dev/console c 5 1
          sudo mknod initramfs/dev/null c 1 3
          
          # Archive Ramdisk ke format CPIO
          cd initramfs
          find . -print0 \
              | cpio --null -o --format=newc > ../initrd.img
          cd ..

      # 16. ðŸš€ QEMU TEST: Booting Penuh ke Shell
      # WARNING: Gunakan 'timeout' agar QEMU tidak berjalan selamanya jika ada hang
      - name: Run QEMU Test (Full Boot to Shell)
        working-directory: linux-src
        run: |
          # Pindah Image.gz dan initrd.img ke working directory biar mudah diakses
          cp arch/arm64/boot/Image.gz .
          cp ../initrd.img .
          
          echo "[*] Starting QEMU Boot Test..."
          
          # Gunakan 'timeout' untuk membatasi waktu boot (misal 60 detik)
          timeout 60s qemu-system-aarch64 \
              -M virt \
              -cpu cortex-a57 \
              -m 512M \
              -kernel Image.gz \
              -initrd initrd.img \
              -nographic \
              -append "console=ttyAMA0 root=/dev/ram0 rw earlyprintk"
          
          echo "[*] QEMU Test Complete. Check logs above for BusyBox shell."

      # 17. Measure build duration (Nomor langkah disesuaikan)
      
